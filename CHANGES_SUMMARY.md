# æ”¹è¿›æ€»ç»“ - æ—¥å¿—å’Œ MCP å¢å¼º

## ğŸ¯ ä¸»è¦æ”¹è¿›

### 1. è¯¦ç»†çš„æ—¥å¿—ç³»ç»Ÿ

#### æ–°å¢ç¯å¢ƒå˜é‡

- **NANO_AGENTSCOPE_LOG_MAX_LENGTH**: æ§åˆ¶å·¥å…·ç»“æœæ˜¾ç¤ºé•¿åº¦
  - `0` = ä¸æˆªæ–­ï¼ˆå®Œæ•´æ˜¾ç¤ºï¼‰
  - `>0` = æˆªæ–­åˆ°æŒ‡å®šå­—ç¬¦æ•°
  - é»˜è®¤: `2000`

- **NANO_AGENTSCOPE_VERBOSE**: å¯ç”¨è¯¦ç»†æ—¥å¿—æ¨¡å¼
  - `0` = ç®€æ´æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰
  - `1` = è¯¦ç»†æ¨¡å¼ï¼ˆæ˜¾ç¤º LLM è¯·æ±‚ã€Token ç»Ÿè®¡ç­‰ï¼‰

#### æ–°å¢æ—¥å¿—åŠŸèƒ½

1. **LLM è¯·æ±‚æ—¥å¿—** (`_print_llm_request`)
   - æ˜¾ç¤ºå‘é€ç»™ LLM çš„æ‰€æœ‰æ¶ˆæ¯
   - æ˜¾ç¤ºå¯ç”¨å·¥å…·åˆ—è¡¨
   - æ ¼å¼åŒ–è¾“å‡ºï¼Œæ˜“äºé˜…è¯»

2. **å·¥å…·è°ƒç”¨æ—¥å¿—** (`_print_tool_call`)
   - è¯¦ç»†æ¨¡å¼ï¼šæ ¼å¼åŒ–æ˜¾ç¤ºå®Œæ•´å‚æ•°
   - ç®€æ´æ¨¡å¼ï¼šå•è¡Œæ˜¾ç¤ºä¸»è¦ä¿¡æ¯

3. **Token ä½¿ç”¨ç»Ÿè®¡** (`_print_token_usage`)
   - è¾“å…¥ tokens
   - è¾“å‡º tokens
   - æ€»è®¡ tokens
   - è€—æ—¶ï¼ˆç§’ï¼‰

4. **å·¥å…·ç»“æœæ—¥å¿—** (æ”¹è¿› `_print_tool_result`)
   - æ”¯æŒé…ç½®æˆªæ–­é•¿åº¦
   - æ˜¾ç¤ºæ€»é•¿åº¦æç¤º
   - æä¾›é…ç½®å»ºè®®

### 2. MCP é”™è¯¯å¤„ç†å¢å¼º

#### è‡ªåŠ¨é‡è¯•æœºåˆ¶

- **HttpStatelessClient.list_tools()**: ç½‘ç»œé”™è¯¯æ—¶è‡ªåŠ¨é‡è¯•ï¼ˆæœ€å¤š 2 æ¬¡ï¼‰
- **MCPToolFunction.__call__()**: å·¥å…·è°ƒç”¨å¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•
- æ”¯æŒçš„é”™è¯¯ç±»å‹ï¼š
  - `aiohttp.ClientPayloadError`
  - `aiohttp.ClientError`
  - `aiohttp.ClientConnectorError`

#### æ”¹è¿›çš„é”™è¯¯æç¤º

- æ˜¾ç¤ºé‡è¯•æ¬¡æ•°å’Œè¿›åº¦
- æ¸…æ™°çš„é”™è¯¯æ¶ˆæ¯
- å»ºè®®æ€§çš„è§£å†³æ–¹æ¡ˆ

#### è¶…æ—¶é…ç½®ä¼˜åŒ–

- é»˜è®¤è¶…æ—¶ä» 30 ç§’å¢åŠ åˆ° 60 ç§’
- æ”¯æŒè‡ªå®šä¹‰è¶…æ—¶æ—¶é—´

### 3. æ–‡æ¡£å®Œå–„

#### æ–°å¢æ–‡æ¡£

1. **LOGGING_GUIDE.md** - å®Œæ•´çš„æ—¥å¿—é…ç½®æŒ‡å—
   - ç¯å¢ƒå˜é‡è¯´æ˜
   - ä½¿ç”¨ç¤ºä¾‹
   - æ¨¡å¼å¯¹æ¯”
   - å¸¸è§é—®é¢˜

2. **MCP_LOGGING.md** - MCP å·¥å…·è°ƒç”¨æ—¥å¿—ä¸“é¡¹æŒ‡å—
   - é—®é¢˜èƒŒæ™¯
   - è§£å†³æ–¹æ¡ˆ
   - é…ç½®è¯´æ˜
   - å®é™…æ¡ˆä¾‹

#### æ”¹è¿›çš„ç¤ºä¾‹

- `examples/mcp_demo.py`: æ·»åŠ æ—¥å¿—é…ç½®è¯´æ˜
- `examples/mcp_demo_enhanced.py`: å®Œæ•´çš„æ—¥å¿—æ¼”ç¤º
- `examples/mcp_demo_with_date_tool.py`: æ—¥æœŸè®¡ç®—å·¥å…·ç¤ºä¾‹

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€ä½¿ç”¨

```python
import os
from nano_agentscope import ReActAgent, DashScopeChatModel

# è®¾ç½®è¯¦ç»†æ—¥å¿—
os.environ["NANO_AGENTSCOPE_LOG_MAX_LENGTH"] = "0"  # å®Œæ•´æ˜¾ç¤º
os.environ["NANO_AGENTSCOPE_VERBOSE"] = "1"          # è¯¦ç»†æ¨¡å¼

agent = ReActAgent(
    name="åŠ©æ‰‹",
    model=DashScopeChatModel(model_name="qwen-max"),
)
```

### å‘½ä»¤è¡Œä½¿ç”¨

```bash
# å¼€å‘è°ƒè¯•
NANO_AGENTSCOPE_VERBOSE=1 NANO_AGENTSCOPE_LOG_MAX_LENGTH=0 python examples/mcp_demo.py

# ç”Ÿäº§ç¯å¢ƒ
NANO_AGENTSCOPE_VERBOSE=0 NANO_AGENTSCOPE_LOG_MAX_LENGTH=500 python your_app.py
```

## ğŸ” æ—¥å¿—è¾“å‡ºç¤ºä¾‹

### è¯¦ç»†æ¨¡å¼è¾“å‡º

```
================================================================================
ğŸ¤– [LLM è¯·æ±‚]
================================================================================

ğŸ“ æ¶ˆæ¯æ•°é‡: 3
  1. [system] ä½ æ˜¯ä¸€ä¸ªåˆ—è½¦åŠ©æ‰‹...
  2. [user] æ˜å¤©ä»åŒ—äº¬åˆ°ä¸Šæµ·çš„è½¦æ¬¡ä¸­æ—¶é—´æœ€çŸ­çš„æ˜¯å“ªä¸€ä¸ª
  3. [assistant] è®©æˆ‘å…ˆè·å–å½“å‰æ—¥æœŸ...

ğŸ”§ å¯ç”¨å·¥å…·: 8
  - get-current-date: è·å–å½“å‰æ—¥æœŸ
  - get-station-code-of-citys: æ ¹æ®åŸå¸‚åç§°è·å–ç«™ç‚¹ä»£ç 
  - get-tickets: æŸ¥è¯¢åˆ—è½¦è½¦æ¬¡ä¿¡æ¯
  ...

================================================================================

ğŸ”§ [è°ƒç”¨å·¥å…·] get-current-date
  å‚æ•°: {}

[å·¥å…·ç»“æœ] get-current-date: 2025-12-30

ğŸ”§ [è°ƒç”¨å·¥å…·] get-station-code-of-citys
  å‚æ•°: {
    "åŒ—äº¬": null,
    "ä¸Šæµ·": null
  }

[å·¥å…·ç»“æœ] get-station-code-of-citys: {"åŒ—äº¬":{"station_code":"BJP",...}}

ğŸ”§ [è°ƒç”¨å·¥å…·] get-tickets
  å‚æ•°: {
    "date": "2025-12-30",
    "from_station": "BJP",
    "to_station": "SHH"
  }

[å·¥å…·ç»“æœ] get-tickets: è½¦æ¬¡|å‡ºå‘ç«™ -> åˆ°è¾¾ç«™|å‡ºå‘æ—¶é—´ -> åˆ°è¾¾æ—¶é—´|å†æ—¶
G21 åŒ—äº¬å—(telecode:VNP) -> ä¸Šæµ·è™¹æ¡¥(telecode:AOH) 17:00 -> 21:18 å†æ—¶ï¼š04:18
- å•†åŠ¡åº§: å‰©ä½™11å¼ ç¥¨ 2318å…ƒ
- ä¸€ç­‰åº§: å‰©ä½™2å¼ ç¥¨ 1060å…ƒ
...

ğŸ“Š [Token ä½¿ç”¨]
  è¾“å…¥: 2345 tokens
  è¾“å‡º: 456 tokens
  æ€»è®¡: 2801 tokens
  è€—æ—¶: 2.15s
```

### ç®€æ´æ¨¡å¼è¾“å‡º

```
åˆ—è½¦åŠ©æ‰‹: è®©æˆ‘å…ˆè·å–å½“å‰æ—¥æœŸ...
  [è°ƒç”¨å·¥å…·] get-current-date: {}
  [å·¥å…·ç»“æœ] get-current-date: 2025-12-30
  [è°ƒç”¨å·¥å…·] get-station-code-of-citys: {"åŒ—äº¬": null, "ä¸Šæµ·": null}
  [å·¥å…·ç»“æœ] get-station-code-of-citys: {"åŒ—äº¬":{"station_code":"BJP",...
  [è°ƒç”¨å·¥å…·] get-tickets: {"date": "2025-12-30", "from_station": "BJP"...
  [å·¥å…·ç»“æœ] get-tickets: è½¦æ¬¡|å‡ºå‘ç«™ -> åˆ°è¾¾ç«™|å‡ºå‘æ—¶é—´ -> åˆ°è¾¾æ—¶é—´...
    ... (å·²æˆªæ–­ï¼Œæ€»é•¿åº¦: 3456 å­—ç¬¦ï¼Œè®¾ç½® NANO_AGENTSCOPE_LOG_MAX_LENGTH=0 æŸ¥çœ‹å®Œæ•´æ—¥å¿—)
```

## ğŸ› ï¸ æŠ€æœ¯æ”¹è¿›

### ä»£ç æ”¹åŠ¨

1. **src/nano_agentscope/agent.py**
   - æ–°å¢ `_print_llm_request()`
   - æ–°å¢ `_print_tool_call()`
   - æ–°å¢ `_print_token_usage()`
   - æ”¹è¿› `_print_tool_result()`
   - åœ¨ `_reasoning()` ä¸­æ·»åŠ è¯·æ±‚æ—¥å¿—
   - åœ¨ `_acting()` ä¸­æ·»åŠ å·¥å…·è°ƒç”¨æ—¥å¿—

2. **src/nano_agentscope/mcp.py**
   - `HttpStatelessClient.list_tools()`: æ·»åŠ è‡ªåŠ¨é‡è¯•
   - `MCPToolFunction.__call__()`: æ·»åŠ è‡ªåŠ¨é‡è¯•
   - å¢åŠ é»˜è®¤è¶…æ—¶æ—¶é—´
   - æ·»åŠ  `url` å±æ€§

3. **examples/mcp_demo.py**
   - æ·»åŠ æ—¥å¿—é…ç½®ç¤ºä¾‹
   - æ”¹è¿›é”™è¯¯å¤„ç†
   - æ·»åŠ é…ç½®è¯´æ˜

## ğŸ é™„åŠ åŠŸèƒ½

### æ—¥æœŸè®¡ç®—å·¥å…·ç¤ºä¾‹

ä¸ºäº†è§£å†³ LLM æ—¥æœŸè®¡ç®—é—®é¢˜ï¼Œæä¾›äº†å·¥å…·å‡½æ•°ç¤ºä¾‹ï¼š

```python
def calculate_date_offset(base_date: str, days_offset: int) -> str:
    """è®¡ç®—æ—¥æœŸåç§»"""
    from datetime import datetime, timedelta
    base = datetime.strptime(base_date, "%Y-%m-%d")
    target = base + timedelta(days=days_offset)
    return target.strftime("%Y-%m-%d")

# æ³¨å†Œåˆ° toolkit
toolkit.register_tool_function(
    func=calculate_date_offset,
    name="calculate-date-offset",
    description="è®¡ç®—æ—¥æœŸåç§»ï¼Œä¾‹å¦‚æ˜å¤©(+1å¤©)ã€åå¤©(+2å¤©)",
)
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ—¥å¿—é…ç½®æŒ‡å—](docs/LOGGING_GUIDE.md)
- [MCP æ—¥å¿—é…ç½®](docs/MCP_LOGGING.md)
- [MCP ç¤ºä¾‹](examples/mcp_demo.py)
- [å¢å¼ºç¤ºä¾‹](examples/mcp_demo_enhanced.py)

## ğŸ”„ å…¼å®¹æ€§

- âœ… å‘åå…¼å®¹ï¼šæ‰€æœ‰æ”¹åŠ¨éƒ½æ˜¯å¯é€‰çš„
- âœ… é»˜è®¤è¡Œä¸ºï¼šä¿æŒåŸæœ‰çš„ç®€æ´è¾“å‡º
- âœ… ç¯å¢ƒå˜é‡ï¼šä¸è®¾ç½®æ—¶ä½¿ç”¨é»˜è®¤å€¼
- âœ… æ€§èƒ½å½±å“ï¼šæœ€å°åŒ–ï¼ˆä»…åœ¨å¯ç”¨è¯¦ç»†æ¨¡å¼æ—¶æœ‰è½»å¾®å¼€é”€ï¼‰

## ğŸš€ ä¸‹ä¸€æ­¥

å»ºè®®çš„åç»­æ”¹è¿›ï¼š

1. **ç»“æ„åŒ–æ—¥å¿—**: æ”¯æŒ JSON æ ¼å¼è¾“å‡º
2. **æ—¥å¿—çº§åˆ«**: æ”¯æŒ DEBUG/INFO/WARN/ERROR
3. **æ—¥å¿—æ–‡ä»¶**: å†…ç½®æ–‡ä»¶æ—¥å¿—åŠŸèƒ½
4. **æ€§èƒ½åˆ†æ**: æ·»åŠ æ›´è¯¦ç»†çš„æ€§èƒ½æŒ‡æ ‡
5. **å¯è§†åŒ–**: æä¾›æ—¥å¿—å¯è§†åŒ–å·¥å…·
